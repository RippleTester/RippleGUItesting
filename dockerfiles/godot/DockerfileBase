FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive

############################################
# 1) Base system + Xfce + VNC + tools
############################################
RUN apt-get update && apt-get install -y \
    xfce4 xfce4-goodies \
    x11vnc xvfb xdotool wmctrl \
    imagemagick x11-apps \
    sudo software-properties-common \
    locales \
 && apt-get remove -y light-locker xfce4-screensaver xfce4-power-manager || true \
 && locale-gen en_US.UTF-8 \
 && update-locale LANG=en_US.UTF-8 \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

############################################
# 2) Firefox ESR (via Mozilla Team PPA)
############################################
RUN add-apt-repository ppa:mozillateam/ppa -y \
 && apt-get update \
 && apt-get install -y --no-install-recommends firefox-esr \
 && update-alternatives --set x-www-browser /usr/bin/firefox-esr \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

############################################
# 3) Python + mozregression
############################################
RUN apt-get update && apt-get install -y python3 python3-pip \
 && pip3 install --no-cache-dir mozregression \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

############################################
# 4) Create non-root user
############################################
RUN useradd -ms /bin/bash myuser \
 && echo "myuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

USER myuser
WORKDIR /home/myuser

############################################
# 5) Configure x11vnc password
############################################
RUN x11vnc -storepasswd secret /home/myuser/.vncpass

############################################
# 6) Run Xvfb + x11vnc + Xfce
############################################
EXPOSE 5900

CMD ["/bin/sh", "-c", "\
    Xvfb :99 -screen 0 1280x800x24 >/dev/null 2>&1 & \
    x11vnc -display :99 -forever -rfbauth /home/myuser/.vncpass -listen 0.0.0.0 -rfbport 5900 >/dev/null 2>&1 & \
    export DISPLAY=:99 && startxfce4 >/dev/null 2>&1 & \
    sleep 2 && echo 'Container running!' && \
    tail -f /dev/null \
"]

############################################
# 7) Build tools (node-gyp etc.)
############################################
USER root
RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    g++ make \
    libxkbfile-dev libsecret-1-dev libkrb5-dev \
    fakeroot rpm \
    python3 python3-pip python3-venv python-is-python3 \
    git libgconf-2-4 \
    curl ca-certificates \
 && python3 -m pip install --upgrade pip setuptools wheel \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

############################################
# 8) Electron runtime dependencies
############################################
RUN apt-get update && apt-get install -y \
    libgtk-3-0 libnss3 libasound2 libxss1 libxtst6 libxrandr2 libglib2.0-0 \
    fonts-liberation fonts-dejavu \
    unzip jq \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

############################################
# 9) NVM + Node.js 22 + Yarn
############################################
USER myuser
ENV NVM_DIR=/home/myuser/.nvm

RUN mkdir -p "$NVM_DIR" \
 && curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash \
 && . "$NVM_DIR/nvm.sh" \
 && nvm install 22 \
 && nvm alias default 22 \
 && echo 'export NVM_DIR=\"$HOME/.nvm\"' >> ~/.bashrc \
 && echo '[ -s \"$NVM_DIR/nvm.sh\" ] && \. \"$NVM_DIR/nvm.sh\"' >> ~/.bashrc \
 && . "$NVM_DIR/nvm.sh" \
 && npm install -g yarn

############################################
# 10) Add missing build libs for your software
############################################
USER root

RUN apt-get update && apt-get install -y \
  scons \
  libxcursor-dev \
  libxinerama-dev \
  libgl1-mesa-dev \
  libglu1-mesa-dev \
  libasound2-dev \
  libpulse-dev \
  libudev-dev \
  libxi-dev \
  libxrandr-dev \
  libwayland-dev \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

############################################
# 11) Final cleanup
############################################
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

USER myuser

############################################
# Usage Instructions
############################################
# Build:
#   docker build -t cua-image .
#
# Run:
#   docker run --rm -it --name cua-image -p 5900:5900 -e DISPLAY=:99 cua-image
#   VNC: vnc://localhost:5900   password: secret

